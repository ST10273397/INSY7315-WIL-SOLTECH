@model List<(ElevatedTutors.Models.ApplicationUser User, IList<string> Roles)>
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Account Permissions";
}

<h2 class="text-center mt-4 mb-3">Account Permissions</h2>

<table class="table table-hover align-middle text-center shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>Account</th>
            <th>Role</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var (user, roles) in Model)
        {
            var roleDisplay = roles.FirstOrDefault() ?? "Unassigned";
            <tr>
                <td>@user.Email</td>
                <td>
                    <span class="badge bg-@(roleDisplay switch {
                        "Admin" => "dark",
                        "Tutor" => "primary",
                        "Student" => "success",
                        _ => "secondary"
                    })">
                        @roleDisplay
                    </span>
                </td>
                <td>
                    <button class="btn btn-info btn-sm text-white" data-bs-toggle="modal" data-bs-target="#viewModal_@user.Id">
                        <i class="bi bi-eye"></i> View
                    </button>

                    <button class="btn btn-warning btn-sm text-white" data-bs-toggle="modal" data-bs-target="#editModal_@user.Id">
                        <i class="bi bi-pencil-square"></i> Edit
                    </button>
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal-@user.Id">
                                                                          <i class="bi bi-trash"></i> Delete
                                                                      </button>
                    
                </td>
            </tr>

            <!-- View Modal -->
            <div class="modal fade" id="viewModal_@user.Id" tabindex="-1" aria-labelledby="viewLabel_@user.Id" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title" id="viewLabel_@user.Id">User Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-start">
                            <p><strong>Email:</strong> @user.Email</p>
                            <p><strong>Username:</strong> @user.UserName</p>
                            <p><strong>Approved:</strong> @(user.IsApproved ? "Yes" : "No")</p>
                            <p><strong>Role:</strong> @roleDisplay</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Modal -->
            <div class="modal fade" id="editModal_@user.Id" tabindex="-1" aria-labelledby="editLabel_@user.Id" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-white">
                            <h5 class="modal-title" id="editLabel_@user.Id">Edit User Role</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form asp-action="EditUserRole" method="post">
                            <div class="modal-body text-start">
                                <input type="hidden" name="id" value="@user.Id" />
                                <label class="form-label">Assign Role:</label>
                                <select name="role" class="form-select">
                                    <option value="">Unassigned</option>
                                    <option value="Tutor" selected="@(roleDisplay == "Tutor")">Tutor</option>
                                    <option value="Student" selected="@(roleDisplay == "Student")">Student</option>
                                    <option value="Admin" selected="@(roleDisplay == "Admin")">Admin</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-success">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Delete Modal -->
                <div class="modal fade" id="deleteModal-@user.Id" tabindex="-1" aria-labelledby="deleteModalLabel-@user.Id" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form asp-action="DeleteAUser" method="post">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title" id="deleteModalLabel-@user.Id">Confirm Delete</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" name="id" value="@user.Id" />
                                    <p>Are you sure you want to delete <strong>@user.Email</strong>? This action cannot be undone.</p>
                                    <p>Type <strong>DELETE</strong> to confirm:</p>
                                    <input type="text" name="confirmText" class="form-control" required />
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger">Delete</button>
                                </div>
                        </form>
                        </div>
                    </div>
                </div>
        }
    </tbody>
</table>
